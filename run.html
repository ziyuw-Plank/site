<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>车辆位置地图</title>
<style>
  html, body {
    margin: 0;
    height: 100%;
    overflow: hidden;
    background: #0f172a;
    color: #e2e8f0;
    font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
  }

  #map {
    width: 100%;
    height: 100%;
  }

  .copy-toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(34, 197, 94, 0.9);
    color: white;
    padding: 12px 24px;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
    z-index: 2000;
    animation: slideDown 0.3s ease;
    backdrop-filter: blur(10px);
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }

  /* 信息窗体样式 */
  .info-window {
    background: rgba(30, 41, 59, 0.95);
    color: #fbbf24;
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .info-window span {
    color: #fbbf24;
    cursor: pointer;
    font-weight: bold;
  }

  .info-window span:hover {
    text-decoration: underline;
  }
</style>

<!-- 高德地图JS API（请在 key= 后填写你的 key） -->
<script src="https://webapi.amap.com/maps?v=2.0&key=d124d3ae2818bf6f9f005f2ed106fbe5"></script>
</head>
<body>
<div id="map"></div>

<script>
let map = null;

async function loadCars(lat, lon) {
  const target = `https://newmapi.7mate.cn/api/new/surrounding/car?latitude=${lat}&longitude=${lon}`;
  const proxyUrl = `https://cors-prfunction-yoolvkcvju.cn-hangzhou.fcapp.run?url=${encodeURIComponent(target)}`;

  try {
    const res = await fetch(proxyUrl);
    const data = await res.json();
    const groups = data?.data || {};
    const allCars = [];

    for (const group of Object.values(groups)) {
      if (Array.isArray(group.cars)) {
        allCars.push(...group.cars);
      }
    }

    if (!allCars.length) {
      showToast("没有车辆数据");
      return;
    }

    // 初始化地图
    initMap(allCars, lat, lon);
  } catch (err) {
    showToast("请求失败：" + err.message);
  }
}

function initMap(cars, lat, lon) {
  map = new AMap.Map("map", {
    viewMode: "3D",
    zoom: 15,
    center: [lon, lat],
    mapStyle: "amap://styles/dark", // 夜间风格（原 darkblue 改为官方支持的 dark）
  });

  cars.forEach(car => {
    const position = [car.longitude, car.latitude];
    const marker = new AMap.Marker({
      position,
      map,
      title: car.number,
      icon: new AMap.Icon({
        image: "https://a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png",
        size: new AMap.Size(25, 34),
        imageSize: new AMap.Size(25, 34)
      })
    });

    const infoContent = `
      <div class="info-window">
        车辆编号：<span onclick="copyNumber('${car.number}')">${car.number}</span><br>
        电池：${car.battery_name || '-'}<br>
        距离基准点：${car.distance} m
      </div>
    `;
    const infoWindow = new AMap.InfoWindow({
      content: infoContent,
      offset: new AMap.Pixel(0, -25)
    });

    marker.on("click", () => {
      infoWindow.open(map, position);
    });
  });
}

function copyNumber(number) {
  navigator.clipboard.writeText(number).then(() => {
    showToast(`已复制: ${number}`);
  }).catch(() => {
    const textarea = document.createElement('textarea');
    textarea.value = number;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showToast(`已复制: ${number}`);
  });
}

function showToast(message) {
  const toast = document.createElement('div');
  toast.className = 'copy-toast';
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.3s ease';
    setTimeout(() => document.body.removeChild(toast), 300);
  }, 2000);
}

const params = new URLSearchParams(window.location.search);
const lat = params.get("lat") || "32.102954";
const lon = params.get("lon") || "118.911875";

loadCars(lat, lon);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è½¦è¾†ä½ç½®åœ°å›¾</title>
<style>
  * {
    box-sizing: border-box;
  }

  html, body {
    margin: 0;
    height: 100%;
    overflow: hidden;
    background: #0f172a;
    color: #e2e8f0;
    font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
  }

  #map {
    width: 100%;
    height: 100%;
  }

  /* åŠ è½½çŠ¶æ€ */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(15, 23, 42, 0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 3000;
    backdrop-filter: blur(5px);
  }

  .spinner {
    width: 50px;
    height: 50px;
    border: 4px solid rgba(251, 191, 36, 0.2);
    border-top-color: #fbbf24;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading-text {
    margin-top: 20px;
    font-size: 16px;
    color: #fbbf24;
  }

  /* æ§åˆ¶é¢æ¿ */
  .control-panel {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(30, 41, 59, 0.95);
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    min-width: 220px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .control-panel h3 {
    margin: 0 0 12px 0;
    font-size: 16px;
    color: #fbbf24;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 8px;
  }

  .stat-item {
    display: flex;
    justify-content: space-between;
    margin: 8px 0;
    font-size: 14px;
  }

  .stat-label {
    color: #94a3b8;
  }

  .stat-value {
    color: #fbbf24;
    font-weight: bold;
  }

  .refresh-btn {
    width: 100%;
    margin-top: 12px;
    padding: 10px;
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    color: #1e293b;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .refresh-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(251, 191, 36, 0.4);
  }

  .refresh-btn:active {
    transform: translateY(0);
  }

  /* Toastæç¤º */
  .copy-toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(34, 197, 94, 0.95);
    color: white;
    padding: 12px 24px;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
    z-index: 2000;
    animation: slideDown 0.3s ease;
    backdrop-filter: blur(10px);
  }

  .error-toast {
    background: rgba(239, 68, 68, 0.95);
    box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }

  /* ä¿¡æ¯çª—ä½“æ ·å¼ */
  .info-window {
    background: rgba(30, 41, 59, 0.98);
    color: #e2e8f0;
    padding: 14px 16px;
    border-radius: 10px;
    font-size: 14px;
    border: 1px solid rgba(251, 191, 36, 0.3);
    min-width: 200px;
  }

  .info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 8px 0;
    padding: 4px 0;
  }

  .info-row:not(:last-child) {
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }

  .info-label {
    color: #94a3b8;
    font-size: 13px;
  }

  .info-value {
    color: #fbbf24;
    font-weight: 600;
  }

  .copy-btn {
    cursor: pointer;
    padding: 4px 12px;
    background: rgba(251, 191, 36, 0.2);
    border-radius: 6px;
    transition: all 0.2s ease;
    position: relative;
    user-select: none;
    -webkit-user-select: none;
  }

  .copy-btn:hover {
    background: rgba(251, 191, 36, 0.4);
    transform: scale(1.05);
  }

  .copy-btn.pressing {
    background: rgba(59, 130, 246, 0.4);
    animation: pulse 0.6s ease-in-out;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }

  .nav-hint {
    position: absolute;
    bottom: -35px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(59, 130, 246, 0.95);
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    animation: fadeInUp 0.3s ease forwards;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(5px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .control-panel {
      top: 10px;
      right: 10px;
      left: 10px;
      min-width: auto;
    }
  }
</style>

<script src="https://webapi.amap.com/maps?v=2.0&key=d124d3ae2818bf6f9f005f2ed106fbe5"></script>
</head>
<body>

<div id="loadingOverlay" class="loading-overlay">
  <div class="spinner"></div>
  <div class="loading-text">åŠ è½½è½¦è¾†æ•°æ®ä¸­...</div>
</div>

<div id="map"></div>

<div class="control-panel">
  <h3>ğŸ“ è½¦è¾†ç»Ÿè®¡</h3>
  <div class="stat-item">
    <span class="stat-label">æ€»è½¦è¾†æ•°</span>
    <span class="stat-value" id="totalCars">0</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">å¹³å‡è·ç¦»</span>
    <span class="stat-value" id="avgDistance">0 m</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">æœ€è¿‘è½¦è¾†</span>
    <span class="stat-value" id="nearestCar">-</span>
  </div>
  <button class="refresh-btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
</div>

<script>
let map = null;
let markers = [];
let currentLat = null;
let currentLon = null;

async function loadCars(lat, lon) {
  const target = `https://newmapi.7mate.cn/api/new/surrounding/car?latitude=${lat}&longitude=${lon}`;
  const proxyUrl = `https://cors-prfunction-yoolvkcvju.cn-hangzhou.fcapp.run?url=${encodeURIComponent(target)}`;

  try {
    const res = await fetch(proxyUrl);
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }

    const data = await res.json();
    const groups = data?.data || {};
    const allCars = [];

    for (const group of Object.values(groups)) {
      if (Array.isArray(group.cars)) {
        allCars.push(...group.cars);
      }
    }

    if (!allCars.length) {
      showToast("å½“å‰ä½ç½®å‘¨è¾¹æš‚æ— è½¦è¾†", true);
      hideLoading();
      return;
    }

    initMap(allCars, lat, lon);
    updateStats(allCars);
    hideLoading();
    
  } catch (err) {
    console.error('åŠ è½½å¤±è´¥:', err);
    showToast("åŠ è½½å¤±è´¥: " + err.message, true);
    hideLoading();
  }
}

function initMap(cars, lat, lon) {
  // æ¸…é™¤æ—§æ ‡è®°
  if (markers.length > 0) {
    markers.forEach(m => m.setMap(null));
    markers = [];
  }

  // åˆå§‹åŒ–æˆ–æ›´æ–°åœ°å›¾
  if (!map) {
    map = new AMap.Map("map", {
      viewMode: "3D",
      zoom: 15,
      center: [lon, lat],
      mapStyle: "amap://styles/dark",
      pitch: 45,
      rotation: 0
    });

    // æ·»åŠ åŸºå‡†ç‚¹æ ‡è®°
    new AMap.Marker({
      position: [lon, lat],
      map,
      icon: new AMap.Icon({
        image: "https://a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png",
        size: new AMap.Size(30, 40),
        imageSize: new AMap.Size(30, 40)
      }),
      title: "åŸºå‡†ç‚¹",
      zIndex: 1000
    });
  } else {
    map.setCenter([lon, lat]);
  }

  // æ·»åŠ è½¦è¾†æ ‡è®°
  cars.forEach(car => {
    const position = [car.longitude, car.latitude];
    const marker = new AMap.Marker({
      position,
      map,
      title: car.number,
      icon: new AMap.Icon({
        image: "https://a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png",
        size: new AMap.Size(25, 34),
        imageSize: new AMap.Size(25, 34)
      })
    });

    markers.push(marker);

    const infoContent = `
      <div class="info-window">
        <div class="info-row">
          <span class="info-label">è½¦è¾†ç¼–å·</span>
          <span class="info-value copy-btn" 
                data-lon="${car.longitude}" 
                data-lat="${car.latitude}"
                data-number="${car.number}"
                onclick="handleNumberClick(event)"
                ontouchstart="handleTouchStart(event)"
                ontouchend="handleTouchEnd(event)"
                ontouchmove="handleTouchMove(event)">${car.number}</span>
        </div>
        <div class="info-row">
          <span class="info-label">ç”µæ± </span>
          <span class="info-value">${car.battery_name || 'æœªçŸ¥'}</span>
        </div>
        <div class="info-row">
          <span class="info-label">è·ç¦»</span>
          <span class="info-value">${car.distance} m</span>
        </div>
      </div>
    `;
    
    const infoWindow = new AMap.InfoWindow({
      content: infoContent,
      offset: new AMap.Pixel(0, -30),
      isCustom: false
    });

    marker.on("click", () => {
      infoWindow.open(map, position);
    });
  });

  // è‡ªåŠ¨é€‚é…è§†é‡
  if (cars.length > 0) {
    const bounds = new AMap.Bounds(
      [Math.min(...cars.map(c => c.longitude)), Math.min(...cars.map(c => c.latitude))],
      [Math.max(...cars.map(c => c.longitude)), Math.max(...cars.map(c => c.latitude))]
    );
    map.setBounds(bounds, false, [100, 100, 100, 100]);
  }
}

function updateStats(cars) {
  document.getElementById('totalCars').textContent = cars.length;
  
  const distances = cars.map(c => parseFloat(c.distance));
  const avgDist = (distances.reduce((a, b) => a + b, 0) / distances.length).toFixed(0);
  document.getElementById('avgDistance').textContent = avgDist + ' m';
  
  const nearest = cars.reduce((min, car) => 
    parseFloat(car.distance) < parseFloat(min.distance) ? car : min
  );
  document.getElementById('nearestCar').textContent = nearest.number;
}

function copyNumber(number) {
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(number).then(() => {
      showToast(`å·²å¤åˆ¶: ${number}`);
    }).catch(() => {
      fallbackCopy(number);
    });
  } else {
    fallbackCopy(number);
  }
}

// é•¿æŒ‰å¯¼èˆªç›¸å…³å˜é‡
let longPressTimer = null;
let isLongPress = false;
let touchMoved = false;

function handleNumberClick(event) {
  // å¦‚æœæ˜¯é•¿æŒ‰è§¦å‘çš„,ä¸æ‰§è¡Œç‚¹å‡»å¤åˆ¶
  if (isLongPress) {
    isLongPress = false;
    return;
  }
  
  const target = event.target;
  const number = target.dataset.number;
  copyNumber(number);
}

function handleTouchStart(event) {
  touchMoved = false;
  isLongPress = false;
  
  const target = event.target;
  const lon = target.dataset.lon;
  const lat = target.dataset.lat;
  const number = target.dataset.number;
  
  // æ·»åŠ æŒ‰å‹æ•ˆæœ
  target.classList.add('pressing');
  
  // æ˜¾ç¤ºæç¤º
  const hint = document.createElement('div');
  hint.className = 'nav-hint';
  hint.textContent = 'ç»§ç»­æŒ‰ä½å¯¼èˆª';
  hint.id = 'nav-hint-' + Date.now();
  target.style.position = 'relative';
  target.appendChild(hint);
  
  // è®¾ç½®é•¿æŒ‰å®šæ—¶å™¨ (600ms)
  longPressTimer = setTimeout(() => {
    if (!touchMoved) {
      isLongPress = true;
      target.classList.remove('pressing');
      
      // ç§»é™¤æç¤º
      const hintEl = target.querySelector('.nav-hint');
      if (hintEl) {
        target.removeChild(hintEl);
      }
      
      // è·³è½¬åˆ°é«˜å¾·å¯¼èˆª
      navigateToAmap(lon, lat, number);
    }
  }, 600);
}

function handleTouchEnd(event) {
  const target = event.target;
  
  // æ¸…é™¤å®šæ—¶å™¨
  if (longPressTimer) {
    clearTimeout(longPressTimer);
    longPressTimer = null;
  }
  
  // ç§»é™¤æŒ‰å‹æ•ˆæœå’Œæç¤º
  target.classList.remove('pressing');
  const hint = target.querySelector('.nav-hint');
  if (hint) {
    target.removeChild(hint);
  }
  
  // å¦‚æœä¸æ˜¯é•¿æŒ‰ä¸”æ²¡æœ‰ç§»åŠ¨,æ‰§è¡Œç‚¹å‡»å¤åˆ¶
  if (!isLongPress && !touchMoved) {
    const number = target.dataset.number;
    copyNumber(number);
  }
  
  // é‡ç½®çŠ¶æ€
  setTimeout(() => {
    isLongPress = false;
    touchMoved = false;
  }, 100);
}

function handleTouchMove(event) {
  touchMoved = true;
  
  const target = event.target;
  
  // ç§»åŠ¨æ—¶å–æ¶ˆé•¿æŒ‰
  if (longPressTimer) {
    clearTimeout(longPressTimer);
    longPressTimer = null;
  }
  
  // ç§»é™¤æ•ˆæœ
  target.classList.remove('pressing');
  const hint = target.querySelector('.nav-hint');
  if (hint) {
    target.removeChild(hint);
  }
}

function navigateToAmap(lon, lat, name) {
  // é«˜å¾·åœ°å›¾å¯¼èˆª URL Scheme
  // æ ¼å¼: amapuri://route/plan/?dlat=ç›®çš„åœ°çº¬åº¦&dlon=ç›®çš„åœ°ç»åº¦&dname=ç›®çš„åœ°åç§°&dev=0&t=0
  // dev=0 è¡¨ç¤ºä½¿ç”¨é«˜å¾·åæ ‡ç³», t=0 è¡¨ç¤ºé©¾è½¦å¯¼èˆª
  
  const amapUrl = `amapuri://route/plan/?dlat=${lat}&dlon=${lon}&dname=${encodeURIComponent('è½¦è¾† ' + name)}&dev=0&t=0`;
  
  showToast('æ­£åœ¨æ‰“å¼€é«˜å¾·åœ°å›¾...');
  
  // å°è¯•æ‰“å¼€é«˜å¾·APP
  window.location.href = amapUrl;
  
  // å¦‚æœ2ç§’åè¿˜åœ¨é¡µé¢,è¯´æ˜å¯èƒ½æ²¡è£…é«˜å¾·APP,æä¾›ç½‘é¡µç‰ˆé“¾æ¥
  setTimeout(() => {
    const webUrl = `https://uri.amap.com/navigation?to=${lon},${lat},è½¦è¾†${name}&mode=car&policy=1&src=myapp&coordinate=gaode&callnative=1`;
    
    // åˆ›å»ºç¡®è®¤æç¤º
    if (confirm('æœªæ£€æµ‹åˆ°é«˜å¾·åœ°å›¾APP,æ˜¯å¦ä½¿ç”¨ç½‘é¡µç‰ˆå¯¼èˆª?')) {
      window.open(webUrl, '_blank');
    }
  }, 2000);
}

function fallbackCopy(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  textarea.select();
  try {
    document.execCommand('copy');
    showToast(`å·²å¤åˆ¶: ${text}`);
  } catch (err) {
    showToast('å¤åˆ¶å¤±è´¥', true);
  }
  document.body.removeChild(textarea);
}

function showToast(message, isError = false) {
  const toast = document.createElement('div');
  toast.className = 'copy-toast' + (isError ? ' error-toast' : '');
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.3s ease';
    setTimeout(() => {
      if (toast.parentNode) {
        document.body.removeChild(toast);
      }
    }, 300);
  }, 2500);
}

function hideLoading() {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) {
    overlay.style.opacity = '0';
    overlay.style.transition = 'opacity 0.3s ease';
    setTimeout(() => {
      if (overlay.parentNode) {
        overlay.parentNode.removeChild(overlay);
      }
    }, 300);
  }
}

function refreshData() {
  if (!currentLat || !currentLon) return;
  
  showToast('åˆ·æ–°ä¸­...');
  loadCars(currentLat, currentLon);
}

// åˆå§‹åŒ–
const params = new URLSearchParams(window.location.search);
currentLat = params.get("lat") || "32.102954";
currentLon = params.get("lon") || "118.911875";

loadCars(currentLat, currentLon);
</script>
</body>
</html>
